# R API client for dlxapi
## Install / Update
The easiest way to install/update `dlxapir`is to install `devtools` and use`install_github`, a short script to do all of this is:
```{R}
install.packages("devtools")
library(devtools)
install_github("dlens/dlxapi", subdir="R")
library(dlxapir)
```

**NOTE:** On MacOSX:
1. Install R language from [https://cran.rstudio.com/](https://cran.rstudio.com/)
1. Install RStudio from the [RStudio website](https://rstudio.com/products/rstudio/download/#download)
1. Install Xcode from the app store
2. Install the Xcode command line tools by opening a Terminal and running:
```
xcode-select --install
```

## Overview
This API client was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the [OpenAPI/Swagger spec](https://github.com/swagger-api/swagger-spec) from a remote server, you can easily generate an API client.

- API version: 1.0
- Package version: 1.0.0
- Build package: io.swagger.codegen.languages.RClientCodegen

# Quickstarts
* [Excel Import](#excel-import)
* [Listing portfolios](#listing-portfolios)
* [Processing errors and reporting](#processing-errors-and-reporting)
* [Listing plans in a portfolio](#listing-plans-in-a-portfolio)
* [Update statuses, start and end date](#update-statuses-start-and-end-date)
* [Update allocations](#update-allocations)

## Excel Import
Here is an example of using the `dlxapir` library to import from an Excel file

```{R}
library(dlxapir)
# What dlx instance are we talking with?
dlx_instance = "INSERT_CLIENT_INSTANCE"
# Your id and credentials go here
id = "Your ID Goes Here!"
secret = "Your secret Goes Here!"

# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)

# Need a PortfoliosApi object to talk to the Portfolio server
portfoliosApi = PortfoliosApi$new()
portfoliosApi$apiClient = apiClient

# Let's get our portfolio, just to make sure things are working
myport = portfolioFromName(apiClient, "Your Portfolio Name Goes Here")
# Print the name just to be sure we actually got the object
print(myport$name)

#We need an SpreadsheetApi object to call to upload our spreadsheet
spreadsheetApi = SpreadsheetApi$new(apiClient)
excel_file="Your_Excel_File_Name_Goes_Here.xlsx"
sheetName = "The sheet in your excel file's name goes here"
#Upload the spreadsheet to the server
spreadsheet = spreadsheetApi$create_spreadsheet(excel_file)
#Now set up the mapping
spreadsheetApi$get_mappings_for_spreadsheet(spreadsheet$content$id, sheetName, "COST", FALSE)
#Now save
rval = portfoliosApi$save_spreadsheet_for_portfolio(myport$id, spreadsheet$content$id, sheetName)

```

## Listing portfolios
```{R}
library(dlxapir)
dlx_instance = "YOUR DLX URL HERE startings with https://"
# Your id and credentials go here
id = "Your ID"
secret = "Your Secret"

# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)

# Need a PortfoliosApi object to talk to the Portfolio server
portfoliosApi = PortfoliosApi$new()
portfoliosApi$apiClient = apiClient

#List portfolios
ports = portfoliosApi$get_portfolios()
for (port in ports$content$items) {
  print(port$name)
}
```

## Processing errors and reporting
We have 2 simple functions for handling basic processing and error reporting to
hopefull make things easier:

1. `processingReportStart()`: Call this at the beginning of your script to begin the report
2. `processingReportNextNotNull()`: Call this function at each step to check for non-null value
3. `processingReportNextResponse()`: Call this function at each step to check for valid http responses

Here is our example for excel import with processing reporting

```{R}
library(dlxapir)
# What dlx instance are we talking with?
dlx_instance = "YOUR DLX URL HERE startings with https://"
# Your id and credentials go here
id = "Your ID"
secret = "Your Secret"

# Start our report of progress
processingReportStart()
# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)
processingReportNextNotNull(apiClient, "Setting up API Client")

# Need a PortfoliosApi object to talk to the Portfolio server
portfoliosApi = PortfoliosApi$new()
processingReportNextNotNull(portfoliosApi, "Setting up Portfolios API Client")
portfoliosApi$apiClient = apiClient

# Let's get our portfolio, just to make sure things are working
portfolioName = "YOUR PORTFOLIO NAME HERE"
portfolioId = "OR YOUR PORTFOLIO ID HERE"
#Get portfolio either by id or by name
#myport = portfolioFromName(apiClient, portfolioName)
myport = portfolioFromId(apiClient, portfolioId)

processingReportNextResponse(myport,"Getting a portfolio by name")

#We need an SpreadsheetApi object to call to upload our spreadsheet
spreadsheetApi = SpreadsheetApi$new(apiClient)
processingReportNextNotNull(spreadsheetApi, "Getting Spreadsheet API")
excel_file="YOUR EXCEL FILE HERE.xlsx"
sheetName = "The name of the sheet in the Excel file to import from"
#Upload the spreadsheet to the server
spreadsheet = spreadsheetApi$create_spreadsheet(excel_file)
processingReportNextResponse(spreadsheet, "Uploading Spreadsheet")

#Now set up the mapping
#The second to last parameter is either "COST" to import cost data, or "PROJECT" to import
#project scores on other fields, e.g. Revenue, Risk, NPV, etc.
spreadsheetApi$get_mappings_for_spreadsheet(spreadsheet$content$id, sheetName, "COST", FALSE)
#Now save
rval = portfoliosApi$save_spreadsheet_for_portfolio(myport$content$id, spreadsheet$content$id, sheetName)
processingReportNextResponse(rval, "Performing import")
```

## Listing plans in a portfolio
```{R}
library(dlxapir)
# What dlx instance are we talking with?
dlx_instance = "YOUR DLX URL HERE startings with https://"
# Your id and credentials go here
id = "Your ID"
secret = "Your Secret"
processingReportStart()

# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)
processingReportNextNotNull(apiClient, "Setting up API Client")


# Need a PortfoliosApi object to talk to the Portfolio server
portfoliosApi = PortfoliosApi$new()
portfoliosApi$apiClient = apiClient
processingReportNextNotNull(portfoliosApi, "Setting up Portfolios API Client")


# Need a PlansApi as well
plansApi = PlansApi$new()
plansApi$apiClient = apiClient
processingReportNextNotNull(plansApi, "Setting up Plans API Client")

# List plans
portfolioPlansApi = PortfolioPlansApi$new(apiClient)
portId = "YOUR PORTFOLIO ID HERE"
port = portfolioFromId(apiClient, portId)
processingReportNextResponse(port, "Getting portfolio")

pplans = portfolioPlansApi$get_portfolio_plans(port$content$id)
processingReportNextResponse(pplans, "Getting plans")
for (pplan in pplans$content$items) {
  cat(pplan$name)
  cat("\n")
}
```

## Update statuses start and end date
* [An example excel file that would work with this code](examples/ExampleUpdateStatusStartEndDateAllocs.xlsx)

```{R}
library(dlxapir)
library(stringr)
library(openxlsx)
dlx_instance = "YOUR_DLX_INSTANCE_HERE"
# Your id and credentials go here
id = "YOUR_DLX_API_ID_HERE"
secret = "YOUR_DLX_API_SECRET_HERE"
processingReportStart()

# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)
processingReportNextNotNull(apiClient, "Setting up API Client")

portId = "YOUR_PORTFOLIO_ID_HERE"
planId = "YOUR_PLAN_ID_HERE"

# Grab the excel file
dataExcelFile="Your_Excel_File_Name_Goes_Here"
Working_Table = read.xlsx(dataExcelFile, sheet = "Schedule")
# Grab project names from the Project Name column of the excel file
projectNames = Working_Table$Project.Name
#Convert project names to project ids
pNamesToIds = projectNamesToIdLookup(apiClient, portId, planId)
projectIds = lapply(projectNames, FUN=function(name) pNamesToIds[name])
#Done converting to projectIds

# Need the status column from excel file
statuses = Working_Table$Status
# Grab the start dates from Start column of excel file
starts = Working_Table$Start
# Grab the end dates from the End column of the excel file
ends = Working_Table$End
#Send the data to update statuses
updateProjectsStatuses(apiClient, portId, planId, projectIds, statuses, paste("Updating statuses from ", dataExcelFile, " "))
#Send the dat to update start dates
updateProjectsStartDates(apiClient, portId, planId, projectIds, starts, paste("Updating starts from ", dataExcelFile, " "))
#Send the data to update end dates
updateProjectsEndDates(apiClient, portId, planId, projectIds, ends, paste("Updating ends from ", dataExcelFile, " "))
```

## Update allocations
* [An example excel file that would work with this code](examples/ExampleUpdateStatusStartEndDateAllocs.xlsx)

```{R}
library(dlxapir)
library(stringr)
library(openxlsx)
dlx_instance = "YOUR_DLX_INSTANCE_HERE"
# Your id and credentials go here
id = "YOUR_DLX_API_ID_HERE"
secret = "YOUR_DLX_API_SECRET_HERE"
processingReportStart()

# You need an ApiClient object to talk to the server.
# This ApiClient object basically has the auth info
apiClient = apiClientFromCreds(dlx_instance, id, secret)
processingReportNextNotNull(apiClient, "Setting up API Client")

portId = "YOUR_PORTFOLIO_ID_HERE"
planId = "YOUR_PLAN_ID_HERE"
costFieldName = "Your Cost Field Name"
# Updating the allocated cost fields (use the 
costField = fieldNameToId(apiClient, portId, paste(costFieldName, "Allocate"))
# You can use the line below to update the cost itself if you like
#costField = fieldNameToId(apiClient, portId, costFieldName)

# Grab the excel file
excelDataFile="../../dropbox/example/BillPlayAreaUpdateStatuses.xlsx"
Working_Table = read.xlsx(excelDataFile, sheet = "Allocated")
# Get project names from Project Name column of the excel file
projectNames = Working_Table$Project.Name
#Convert project names to project ids
projectIds = projectNameToId(apiClient, portId, planId, projectNames)
for (dateString in colnames(Working_Table)) {
  # For each column, see if its header is a date, if so, send that
  # column as costs
  date = dateAsMillis(dateString)
  if (!is.na(date)) {
    # We have a cost column with a date, grab it from Excel file
    allocs = Working_Table[[dateString]]
    # Send the data to DLX
    updateProjectsAllocs(apiClient, planId, costFieldId, dateString, "YEAR", projectIds, allocs, paste0("Updating allocs by vector for date ", dateString))
  }
}
```
